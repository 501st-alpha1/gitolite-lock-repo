#!/usr/bin/perl
use strict;
use warnings;

use lib $ENV{GL_LIBDIR};
use Gitolite::Common;

use POSIX qw( strftime );

# gitolite VREF to lock and unlock (repository.  Requires companion command
# 'lock-repo' to be enabled.

# ----------------------------------------------------------------------

# see gitolite docs for what the first 7 arguments mean

die "not meant to be run manually" unless $ARGV[6];

my $ff = "$ENV{GL_REPO_BASE}/$ENV{GL_REPO}.git/gl-lockrepo";
exit 0 unless -f $ff;

our %lock;
my $t = slurp($ff);
eval $t;
_die "do '$ff' failed with '$@', contact your administrator" if $@;

if ( defined(%lock) and $lock{USER} ne $ENV{GL_USER} ) {
    my $dt = strftime("%Y-%m-%d %H:%M:%S", localtime($lock{TIME}));
    print "Repository locked by $lock{USER} since $dt with message: $lock{MESSAGE} ";
    exit 1
}

exit 0
